{
  "version": "1",
  "file": "password-auth.allium",
  "metadata": {
    "scope": "authentication",
    "description": "Password authentication with reset flow"
  },
  "use_declarations": [
    {
      "coordinate": "org.example:email-infrastructure",
      "alias": "email_infra"
    }
  ],
  "given": [
    {
      "name": "email_service",
      "type": {
        "kind": "entity_ref",
        "entity": "EmailService"
      }
    }
  ],
  "external_entities": [
    {
      "name": "Email",
      "fields": [
        {
          "name": "to",
          "type": { "kind": "primitive", "value": "String" }
        },
        {
          "name": "template",
          "type": { "kind": "primitive", "value": "String" }
        },
        {
          "name": "data",
          "type": {
            "kind": "optional",
            "inner": { "kind": "primitive", "value": "String" }
          }
        }
      ]
    },
    {
      "name": "EmailService",
      "fields": [
        {
          "name": "provider",
          "type": { "kind": "primitive", "value": "String" }
        },
        {
          "name": "is_configured",
          "type": { "kind": "primitive", "value": "Boolean" }
        }
      ]
    },
    {
      "name": "AuditLog",
      "fields": [
        {
          "name": "user",
          "type": { "kind": "entity_ref", "entity": "User" }
        },
        {
          "name": "event",
          "type": { "kind": "named_enum", "name": "AuthEventType" }
        },
        {
          "name": "timestamp",
          "type": { "kind": "primitive", "value": "Timestamp" }
        },
        {
          "name": "metadata",
          "type": {
            "kind": "optional",
            "inner": { "kind": "primitive", "value": "String" }
          }
        }
      ]
    }
  ],
  "value_types": [
    {
      "name": "TokenData",
      "fields": [
        {
          "name": "token_value",
          "type": { "kind": "primitive", "value": "String" }
        },
        {
          "name": "issued_at",
          "type": { "kind": "primitive", "value": "Timestamp" }
        }
      ],
      "derived_values": [
        {
          "name": "age",
          "expression": {
            "kind": "arithmetic",
            "operator": "-",
            "left": { "kind": "literal", "type": "timestamp", "value": "now" },
            "right": { "kind": "field_access", "object": null, "field": "issued_at" }
          }
        }
      ]
    }
  ],
  "enumerations": [
    {
      "name": "AuthEventType",
      "values": [
        "login_success",
        "login_failure",
        "password_reset",
        "account_locked",
        "account_unlocked"
      ]
    }
  ],
  "entities": [
    {
      "name": "User",
      "fields": [
        {
          "name": "email",
          "type": { "kind": "primitive", "value": "String" }
        },
        {
          "name": "password_hash",
          "type": { "kind": "primitive", "value": "String" }
        },
        {
          "name": "status",
          "type": {
            "kind": "inline_enum",
            "values": ["active", "locked", "deactivated"]
          }
        },
        {
          "name": "failed_login_attempts",
          "type": { "kind": "primitive", "value": "Integer" }
        },
        {
          "name": "locked_until",
          "type": {
            "kind": "optional",
            "inner": { "kind": "primitive", "value": "Timestamp" }
          }
        },
        {
          "name": "trusted_ips",
          "type": {
            "kind": "set",
            "element": { "kind": "primitive", "value": "String" }
          }
        }
      ],
      "relationships": [
        {
          "name": "sessions",
          "target_entity": "Session",
          "foreign_key": "user",
          "cardinality": "many"
        },
        {
          "name": "reset_tokens",
          "target_entity": "PasswordResetToken",
          "foreign_key": "user",
          "cardinality": "many"
        }
      ],
      "projections": [
        {
          "name": "active_sessions",
          "source": "sessions",
          "condition": {
            "kind": "comparison",
            "operator": "=",
            "left": { "kind": "field_access", "object": null, "field": "status" },
            "right": { "kind": "literal", "type": "enum_value", "value": "active" }
          }
        },
        {
          "name": "pending_reset_tokens",
          "source": "reset_tokens",
          "condition": {
            "kind": "comparison",
            "operator": "=",
            "left": { "kind": "field_access", "object": null, "field": "status" },
            "right": { "kind": "literal", "type": "enum_value", "value": "pending" }
          }
        }
      ],
      "derived_values": [
        {
          "name": "is_locked",
          "expression": {
            "kind": "boolean_logic",
            "operator": "and",
            "left": {
              "kind": "comparison",
              "operator": "=",
              "left": { "kind": "field_access", "object": null, "field": "status" },
              "right": { "kind": "literal", "type": "enum_value", "value": "locked" }
            },
            "right": {
              "kind": "comparison",
              "operator": ">",
              "left": { "kind": "field_access", "object": null, "field": "locked_until" },
              "right": { "kind": "literal", "type": "timestamp", "value": "now" }
            }
          }
        },
        {
          "name": "has_valid_session",
          "expression": {
            "kind": "collection_op",
            "operation": "any",
            "collection": { "kind": "field_access", "object": null, "field": "active_sessions" },
            "lambda": {
              "kind": "lambda",
              "parameter": "s",
              "body": {
                "kind": "field_access",
                "object": { "kind": "field_access", "object": null, "field": "s" },
                "field": "is_valid"
              }
            }
          }
        }
      ]
    },
    {
      "name": "Session",
      "fields": [
        {
          "name": "user",
          "type": { "kind": "entity_ref", "entity": "User" }
        },
        {
          "name": "created_at",
          "type": { "kind": "primitive", "value": "Timestamp" }
        },
        {
          "name": "expires_at",
          "type": { "kind": "primitive", "value": "Timestamp" }
        },
        {
          "name": "status",
          "type": {
            "kind": "inline_enum",
            "values": ["active", "expired", "revoked"]
          }
        }
      ],
      "relationships": [],
      "projections": [],
      "derived_values": [
        {
          "name": "is_valid",
          "expression": {
            "kind": "boolean_logic",
            "operator": "and",
            "left": {
              "kind": "comparison",
              "operator": "=",
              "left": { "kind": "field_access", "object": null, "field": "status" },
              "right": { "kind": "literal", "type": "enum_value", "value": "active" }
            },
            "right": {
              "kind": "comparison",
              "operator": ">",
              "left": { "kind": "field_access", "object": null, "field": "expires_at" },
              "right": { "kind": "literal", "type": "timestamp", "value": "now" }
            }
          }
        }
      ]
    },
    {
      "name": "PasswordResetToken",
      "fields": [
        {
          "name": "user",
          "type": { "kind": "entity_ref", "entity": "User" }
        },
        {
          "name": "created_at",
          "type": { "kind": "primitive", "value": "Timestamp" }
        },
        {
          "name": "expires_at",
          "type": { "kind": "primitive", "value": "Timestamp" }
        },
        {
          "name": "status",
          "type": {
            "kind": "inline_enum",
            "values": ["pending", "used", "expired"]
          }
        }
      ],
      "relationships": [],
      "projections": [],
      "derived_values": [
        {
          "name": "is_valid",
          "expression": {
            "kind": "boolean_logic",
            "operator": "and",
            "left": {
              "kind": "comparison",
              "operator": "=",
              "left": { "kind": "field_access", "object": null, "field": "status" },
              "right": { "kind": "literal", "type": "enum_value", "value": "pending" }
            },
            "right": {
              "kind": "comparison",
              "operator": ">",
              "left": { "kind": "field_access", "object": null, "field": "expires_at" },
              "right": { "kind": "literal", "type": "timestamp", "value": "now" }
            }
          }
        }
      ]
    }
  ],
  "variants": [],
  "config": [
    {
      "name": "min_password_length",
      "type": { "kind": "primitive", "value": "Integer" },
      "default_value": { "kind": "literal", "type": "integer", "value": 12 }
    },
    {
      "name": "max_login_attempts",
      "type": { "kind": "primitive", "value": "Integer" },
      "default_value": { "kind": "literal", "type": "integer", "value": 5 }
    },
    {
      "name": "lockout_duration",
      "type": { "kind": "primitive", "value": "Duration" },
      "default_value": { "kind": "literal", "type": "duration", "value": "15.minutes" }
    },
    {
      "name": "reset_token_expiry",
      "type": { "kind": "primitive", "value": "Duration" },
      "default_value": { "kind": "literal", "type": "duration", "value": "1.hour" }
    },
    {
      "name": "session_duration",
      "type": { "kind": "primitive", "value": "Duration" },
      "default_value": { "kind": "literal", "type": "duration", "value": "24.hours" }
    }
  ],
  "defaults": [
    {
      "entity": "User",
      "name": "system_user",
      "fields": {
        "email": { "kind": "literal", "type": "string", "value": "system@internal" },
        "password_hash": { "kind": "literal", "type": "string", "value": "" },
        "status": { "kind": "literal", "type": "enum_value", "value": "active" },
        "failed_login_attempts": { "kind": "literal", "type": "integer", "value": 0 }
      }
    }
  ],
  "rules": [
    {
      "name": "Register",
      "trigger": {
        "kind": "external_stimulus",
        "name": "UserRegisters",
        "parameters": [
          { "name": "email" },
          { "name": "password" }
        ]
      },
      "let_bindings": [],
      "requires": [
        {
          "kind": "not",
          "operand": {
            "kind": "exists",
            "target": {
              "kind": "join_lookup",
              "entity": "User",
              "fields": {
                "email": { "kind": "field_access", "object": null, "field": "email" }
              }
            }
          }
        },
        {
          "kind": "comparison",
          "operator": ">=",
          "left": {
            "kind": "function_call",
            "name": "length",
            "arguments": [
              { "kind": "field_access", "object": null, "field": "password" }
            ]
          },
          "right": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "config" },
            "field": "min_password_length"
          }
        }
      ],
      "ensures": [
        {
          "kind": "entity_creation",
          "entity": "User",
          "fields": {
            "email": { "kind": "field_access", "object": null, "field": "email" },
            "password_hash": {
              "kind": "function_call",
              "name": "hash",
              "arguments": [
                { "kind": "field_access", "object": null, "field": "password" }
              ]
            },
            "status": { "kind": "literal", "type": "enum_value", "value": "active" },
            "failed_login_attempts": { "kind": "literal", "type": "integer", "value": 0 }
          }
        },
        {
          "kind": "entity_creation",
          "entity": "Email",
          "fields": {
            "to": { "kind": "field_access", "object": null, "field": "email" },
            "template": { "kind": "literal", "type": "enum_value", "value": "welcome" }
          }
        }
      ]
    },
    {
      "name": "LoginSuccess",
      "trigger": {
        "kind": "external_stimulus",
        "name": "UserLogsIn",
        "parameters": [
          { "name": "email" },
          { "name": "password" }
        ]
      },
      "let_bindings": [
        {
          "name": "user",
          "expression": {
            "kind": "join_lookup",
            "entity": "User",
            "fields": {
              "email": { "kind": "field_access", "object": null, "field": "email" }
            }
          }
        }
      ],
      "requires": [
        {
          "kind": "exists",
          "target": { "kind": "field_access", "object": null, "field": "user" }
        },
        {
          "kind": "not",
          "operand": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "user" },
            "field": "is_locked"
          }
        },
        {
          "kind": "function_call",
          "name": "verify",
          "arguments": [
            { "kind": "field_access", "object": null, "field": "password" },
            {
              "kind": "field_access",
              "object": { "kind": "field_access", "object": null, "field": "user" },
              "field": "password_hash"
            }
          ]
        }
      ],
      "ensures": [
        {
          "kind": "state_change",
          "target": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "user" },
            "field": "failed_login_attempts"
          },
          "value": { "kind": "literal", "type": "integer", "value": 0 }
        },
        {
          "kind": "entity_creation",
          "entity": "Session",
          "fields": {
            "user": { "kind": "field_access", "object": null, "field": "user" },
            "created_at": { "kind": "literal", "type": "timestamp", "value": "now" },
            "expires_at": {
              "kind": "arithmetic",
              "operator": "+",
              "left": { "kind": "literal", "type": "timestamp", "value": "now" },
              "right": {
                "kind": "field_access",
                "object": { "kind": "field_access", "object": null, "field": "config" },
                "field": "session_duration"
              }
            },
            "status": { "kind": "literal", "type": "enum_value", "value": "active" }
          }
        }
      ]
    },
    {
      "name": "LoginFailure",
      "trigger": {
        "kind": "external_stimulus",
        "name": "UserLogsIn",
        "parameters": [
          { "name": "email" },
          { "name": "password" }
        ]
      },
      "let_bindings": [
        {
          "name": "user",
          "expression": {
            "kind": "join_lookup",
            "entity": "User",
            "fields": {
              "email": { "kind": "field_access", "object": null, "field": "email" }
            }
          }
        }
      ],
      "requires": [
        {
          "kind": "exists",
          "target": { "kind": "field_access", "object": null, "field": "user" }
        },
        {
          "kind": "not",
          "operand": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "user" },
            "field": "is_locked"
          }
        },
        {
          "kind": "not",
          "operand": {
            "kind": "function_call",
            "name": "verify",
            "arguments": [
              { "kind": "field_access", "object": null, "field": "password" },
              {
                "kind": "field_access",
                "object": { "kind": "field_access", "object": null, "field": "user" },
                "field": "password_hash"
              }
            ]
          }
        }
      ],
      "ensures": [
        {
          "kind": "state_change",
          "target": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "user" },
            "field": "failed_login_attempts"
          },
          "value": {
            "kind": "arithmetic",
            "operator": "+",
            "left": {
              "kind": "field_access",
              "object": { "kind": "field_access", "object": null, "field": "user" },
              "field": "failed_login_attempts"
            },
            "right": { "kind": "literal", "type": "integer", "value": 1 }
          }
        },
        {
          "kind": "conditional",
          "condition": {
            "kind": "comparison",
            "operator": ">=",
            "left": {
              "kind": "field_access",
              "object": { "kind": "field_access", "object": null, "field": "user" },
              "field": "failed_login_attempts"
            },
            "right": {
              "kind": "field_access",
              "object": { "kind": "field_access", "object": null, "field": "config" },
              "field": "max_login_attempts"
            }
          },
          "then": [
            {
              "kind": "state_change",
              "target": {
                "kind": "field_access",
                "object": { "kind": "field_access", "object": null, "field": "user" },
                "field": "status"
              },
              "value": { "kind": "literal", "type": "enum_value", "value": "locked" }
            },
            {
              "kind": "state_change",
              "target": {
                "kind": "field_access",
                "object": { "kind": "field_access", "object": null, "field": "user" },
                "field": "locked_until"
              },
              "value": {
                "kind": "arithmetic",
                "operator": "+",
                "left": { "kind": "literal", "type": "timestamp", "value": "now" },
                "right": {
                  "kind": "field_access",
                  "object": { "kind": "field_access", "object": null, "field": "config" },
                  "field": "lockout_duration"
                }
              }
            },
            {
              "kind": "entity_creation",
              "entity": "Email",
              "fields": {
                "to": {
                  "kind": "field_access",
                  "object": { "kind": "field_access", "object": null, "field": "user" },
                  "field": "email"
                },
                "template": { "kind": "literal", "type": "enum_value", "value": "account_locked" }
              }
            },
            {
              "kind": "trigger_emission",
              "name": "AccountLockTriggered",
              "arguments": {
                "user": { "kind": "field_access", "object": null, "field": "user" }
              }
            }
          ],
          "else": []
        }
      ]
    },
    {
      "name": "LoginAttemptWhileLocked",
      "trigger": {
        "kind": "external_stimulus",
        "name": "UserLogsIn",
        "parameters": [
          { "name": "email" },
          { "name": "password" }
        ]
      },
      "let_bindings": [
        {
          "name": "user",
          "expression": {
            "kind": "join_lookup",
            "entity": "User",
            "fields": {
              "email": { "kind": "field_access", "object": null, "field": "email" }
            }
          }
        }
      ],
      "requires": [
        {
          "kind": "exists",
          "target": { "kind": "field_access", "object": null, "field": "user" }
        },
        {
          "kind": "field_access",
          "object": { "kind": "field_access", "object": null, "field": "user" },
          "field": "is_locked"
        }
      ],
      "ensures": [
        {
          "kind": "trigger_emission",
          "name": "UserInformed",
          "arguments": {
            "user": { "kind": "field_access", "object": null, "field": "user" },
            "about": { "kind": "literal", "type": "enum_value", "value": "account_locked" },
            "data": {
              "kind": "field_access",
              "object": { "kind": "field_access", "object": null, "field": "user" },
              "field": "locked_until"
            }
          }
        }
      ]
    },
    {
      "name": "LockoutExpires",
      "trigger": {
        "kind": "temporal",
        "binding": "user",
        "entity": "User",
        "condition": {
          "kind": "comparison",
          "operator": "<=",
          "left": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "user" },
            "field": "locked_until"
          },
          "right": { "kind": "literal", "type": "timestamp", "value": "now" }
        }
      },
      "let_bindings": [],
      "requires": [
        {
          "kind": "comparison",
          "operator": "=",
          "left": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "user" },
            "field": "status"
          },
          "right": { "kind": "literal", "type": "enum_value", "value": "locked" }
        }
      ],
      "ensures": [
        {
          "kind": "state_change",
          "target": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "user" },
            "field": "status"
          },
          "value": { "kind": "literal", "type": "enum_value", "value": "active" }
        },
        {
          "kind": "state_change",
          "target": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "user" },
            "field": "failed_login_attempts"
          },
          "value": { "kind": "literal", "type": "integer", "value": 0 }
        },
        {
          "kind": "state_change",
          "target": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "user" },
            "field": "locked_until"
          },
          "value": { "kind": "literal", "type": "null", "value": null }
        }
      ]
    },
    {
      "name": "Logout",
      "trigger": {
        "kind": "external_stimulus",
        "name": "UserLogsOut",
        "parameters": [
          { "name": "session" }
        ]
      },
      "let_bindings": [],
      "requires": [
        {
          "kind": "comparison",
          "operator": "=",
          "left": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "session" },
            "field": "status"
          },
          "right": { "kind": "literal", "type": "enum_value", "value": "active" }
        }
      ],
      "ensures": [
        {
          "kind": "state_change",
          "target": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "session" },
            "field": "status"
          },
          "value": { "kind": "literal", "type": "enum_value", "value": "revoked" }
        }
      ]
    },
    {
      "name": "SessionExpires",
      "trigger": {
        "kind": "temporal",
        "binding": "session",
        "entity": "Session",
        "condition": {
          "kind": "comparison",
          "operator": "<=",
          "left": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "session" },
            "field": "expires_at"
          },
          "right": { "kind": "literal", "type": "timestamp", "value": "now" }
        }
      },
      "let_bindings": [],
      "requires": [
        {
          "kind": "comparison",
          "operator": "=",
          "left": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "session" },
            "field": "status"
          },
          "right": { "kind": "literal", "type": "enum_value", "value": "active" }
        }
      ],
      "ensures": [
        {
          "kind": "state_change",
          "target": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "session" },
            "field": "status"
          },
          "value": { "kind": "literal", "type": "enum_value", "value": "expired" }
        }
      ]
    },
    {
      "name": "RequestPasswordReset",
      "trigger": {
        "kind": "external_stimulus",
        "name": "UserRequestsPasswordReset",
        "parameters": [
          { "name": "email" }
        ]
      },
      "let_bindings": [
        {
          "name": "user",
          "expression": {
            "kind": "join_lookup",
            "entity": "User",
            "fields": {
              "email": { "kind": "field_access", "object": null, "field": "email" }
            }
          }
        }
      ],
      "requires": [
        {
          "kind": "exists",
          "target": { "kind": "field_access", "object": null, "field": "user" }
        },
        {
          "kind": "membership",
          "element": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "user" },
            "field": "status"
          },
          "collection": {
            "kind": "set_literal",
            "elements": [
              { "kind": "literal", "type": "enum_value", "value": "active" },
              { "kind": "literal", "type": "enum_value", "value": "locked" }
            ]
          }
        }
      ],
      "ensures": [
        {
          "kind": "iteration",
          "binding": "t",
          "collection": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "user" },
            "field": "pending_reset_tokens"
          },
          "body": [
            {
              "kind": "state_change",
              "target": {
                "kind": "field_access",
                "object": { "kind": "field_access", "object": null, "field": "t" },
                "field": "status"
              },
              "value": { "kind": "literal", "type": "enum_value", "value": "expired" }
            }
          ]
        },
        {
          "kind": "let_binding",
          "name": "token",
          "value": {
            "kind": "entity_creation",
            "entity": "PasswordResetToken",
            "fields": {
              "user": { "kind": "field_access", "object": null, "field": "user" },
              "created_at": { "kind": "literal", "type": "timestamp", "value": "now" },
              "expires_at": {
                "kind": "arithmetic",
                "operator": "+",
                "left": { "kind": "literal", "type": "timestamp", "value": "now" },
                "right": {
                  "kind": "field_access",
                  "object": { "kind": "field_access", "object": null, "field": "config" },
                  "field": "reset_token_expiry"
                }
              },
              "status": { "kind": "literal", "type": "enum_value", "value": "pending" }
            }
          },
          "body": [
            {
              "kind": "entity_creation",
              "entity": "Email",
              "fields": {
                "to": { "kind": "field_access", "object": null, "field": "email" },
                "template": { "kind": "literal", "type": "enum_value", "value": "password_reset" }
              }
            }
          ]
        }
      ]
    },
    {
      "name": "CompletePasswordReset",
      "trigger": {
        "kind": "external_stimulus",
        "name": "UserResetsPassword",
        "parameters": [
          { "name": "token" },
          { "name": "new_password" }
        ]
      },
      "let_bindings": [
        {
          "name": "user",
          "expression": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "token" },
            "field": "user"
          }
        }
      ],
      "requires": [
        {
          "kind": "field_access",
          "object": { "kind": "field_access", "object": null, "field": "token" },
          "field": "is_valid"
        },
        {
          "kind": "comparison",
          "operator": ">=",
          "left": {
            "kind": "function_call",
            "name": "length",
            "arguments": [
              { "kind": "field_access", "object": null, "field": "new_password" }
            ]
          },
          "right": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "config" },
            "field": "min_password_length"
          }
        }
      ],
      "ensures": [
        {
          "kind": "state_change",
          "target": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "token" },
            "field": "status"
          },
          "value": { "kind": "literal", "type": "enum_value", "value": "used" }
        },
        {
          "kind": "state_change",
          "target": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "user" },
            "field": "password_hash"
          },
          "value": {
            "kind": "function_call",
            "name": "hash",
            "arguments": [
              { "kind": "field_access", "object": null, "field": "new_password" }
            ]
          }
        },
        {
          "kind": "state_change",
          "target": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "user" },
            "field": "status"
          },
          "value": { "kind": "literal", "type": "enum_value", "value": "active" }
        },
        {
          "kind": "state_change",
          "target": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "user" },
            "field": "failed_login_attempts"
          },
          "value": { "kind": "literal", "type": "integer", "value": 0 }
        },
        {
          "kind": "state_change",
          "target": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "user" },
            "field": "locked_until"
          },
          "value": { "kind": "literal", "type": "null", "value": null }
        },
        {
          "kind": "iteration",
          "binding": "s",
          "collection": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "user" },
            "field": "active_sessions"
          },
          "body": [
            {
              "kind": "state_change",
              "target": {
                "kind": "field_access",
                "object": { "kind": "field_access", "object": null, "field": "s" },
                "field": "status"
              },
              "value": { "kind": "literal", "type": "enum_value", "value": "revoked" }
            }
          ]
        },
        {
          "kind": "entity_creation",
          "entity": "Email",
          "fields": {
            "to": {
              "kind": "field_access",
              "object": { "kind": "field_access", "object": null, "field": "user" },
              "field": "email"
            },
            "template": { "kind": "literal", "type": "enum_value", "value": "password_changed" }
          }
        }
      ]
    },
    {
      "name": "ResetTokenExpires",
      "trigger": {
        "kind": "temporal",
        "binding": "token",
        "entity": "PasswordResetToken",
        "condition": {
          "kind": "comparison",
          "operator": "<=",
          "left": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "token" },
            "field": "expires_at"
          },
          "right": { "kind": "literal", "type": "timestamp", "value": "now" }
        }
      },
      "let_bindings": [],
      "requires": [
        {
          "kind": "comparison",
          "operator": "=",
          "left": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "token" },
            "field": "status"
          },
          "right": { "kind": "literal", "type": "enum_value", "value": "pending" }
        }
      ],
      "ensures": [
        {
          "kind": "state_change",
          "target": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "token" },
            "field": "status"
          },
          "value": { "kind": "literal", "type": "enum_value", "value": "expired" }
        }
      ]
    },
    {
      "name": "NotifyAccountLocked",
      "trigger": {
        "kind": "state_transition",
        "binding": "user",
        "entity": "User",
        "field": "status",
        "to_value": "locked"
      },
      "let_bindings": [],
      "requires": [],
      "ensures": [
        {
          "kind": "entity_creation",
          "entity": "AuditLog",
          "fields": {
            "user": { "kind": "field_access", "object": null, "field": "user" },
            "event": { "kind": "literal", "type": "enum_value", "value": "account_locked" },
            "timestamp": { "kind": "literal", "type": "timestamp", "value": "now" }
          }
        }
      ]
    },
    {
      "name": "TrackSessionActivation",
      "trigger": {
        "kind": "state_becomes",
        "binding": "session",
        "entity": "Session",
        "field": "status",
        "value": "active"
      },
      "let_bindings": [],
      "requires": [],
      "ensures": [
        {
          "kind": "entity_creation",
          "entity": "AuditLog",
          "fields": {
            "user": {
              "kind": "field_access",
              "object": { "kind": "field_access", "object": null, "field": "session" },
              "field": "user"
            },
            "event": { "kind": "literal", "type": "enum_value", "value": "login_success" },
            "timestamp": { "kind": "literal", "type": "timestamp", "value": "now" }
          }
        }
      ]
    },
    {
      "name": "HandleUserLocked",
      "trigger": {
        "kind": "derived_condition",
        "binding": "user",
        "entity": "User",
        "field": "is_locked"
      },
      "let_bindings": [],
      "requires": [],
      "ensures": [
        {
          "kind": "entity_creation",
          "entity": "Email",
          "fields": {
            "to": {
              "kind": "field_access",
              "object": { "kind": "field_access", "object": null, "field": "user" },
              "field": "email"
            },
            "template": { "kind": "literal", "type": "enum_value", "value": "account_locked_warning" }
          }
        }
      ]
    },
    {
      "name": "AuditNewSession",
      "trigger": {
        "kind": "entity_creation",
        "binding": "session",
        "entity": "Session"
      },
      "let_bindings": [],
      "requires": [
        {
          "kind": "comparison",
          "operator": "=",
          "left": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "session" },
            "field": "status"
          },
          "right": { "kind": "literal", "type": "enum_value", "value": "active" }
        }
      ],
      "ensures": [
        {
          "kind": "entity_creation",
          "entity": "AuditLog",
          "fields": {
            "user": {
              "kind": "field_access",
              "object": { "kind": "field_access", "object": null, "field": "session" },
              "field": "user"
            },
            "event": { "kind": "literal", "type": "enum_value", "value": "login_success" },
            "timestamp": {
              "kind": "null_coalesce",
              "left": {
                "kind": "field_access",
                "object": { "kind": "field_access", "object": null, "field": "session" },
                "field": "created_at"
              },
              "right": { "kind": "literal", "type": "timestamp", "value": "now" }
            }
          }
        }
      ]
    },
    {
      "name": "NotifySecurityTeam",
      "trigger": {
        "kind": "chained",
        "name": "AccountLockTriggered",
        "parameters": [
          { "name": "user" }
        ]
      },
      "let_bindings": [],
      "requires": [],
      "ensures": [
        {
          "kind": "entity_creation",
          "entity": "Email",
          "fields": {
            "to": { "kind": "literal", "type": "string", "value": "security@example.com" },
            "template": { "kind": "literal", "type": "enum_value", "value": "security_alert" },
            "data": {
              "kind": "field_access",
              "object": { "kind": "field_access", "object": null, "field": "user" },
              "field": "email"
            }
          }
        }
      ]
    },
    {
      "name": "AdminRevokesSession",
      "trigger": {
        "kind": "external_stimulus",
        "name": "AdminRevokesSession",
        "parameters": [
          { "name": "admin" },
          { "name": "session" }
        ]
      },
      "let_bindings": [],
      "requires": [
        {
          "kind": "comparison",
          "operator": "=",
          "left": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "session" },
            "field": "status"
          },
          "right": { "kind": "literal", "type": "enum_value", "value": "active" }
        }
      ],
      "ensures": [
        {
          "kind": "entity_removal",
          "target": { "kind": "field_access", "object": null, "field": "session" }
        }
      ]
    },
    {
      "name": "DeactivateAccount",
      "trigger": {
        "kind": "external_stimulus",
        "name": "AdminDeactivatesAccount",
        "parameters": [
          { "name": "admin" },
          { "name": "user" }
        ]
      },
      "let_bindings": [],
      "requires": [
        {
          "kind": "comparison",
          "operator": "!=",
          "left": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "user" },
            "field": "status"
          },
          "right": { "kind": "literal", "type": "enum_value", "value": "deactivated" }
        }
      ],
      "ensures": [
        {
          "kind": "state_change",
          "target": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "user" },
            "field": "status"
          },
          "value": { "kind": "literal", "type": "enum_value", "value": "deactivated" }
        },
        {
          "kind": "iteration",
          "binding": "s",
          "collection": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "user" },
            "field": "active_sessions"
          },
          "body": [
            {
              "kind": "state_change",
              "target": {
                "kind": "field_access",
                "object": { "kind": "field_access", "object": null, "field": "s" },
                "field": "status"
              },
              "value": { "kind": "literal", "type": "enum_value", "value": "revoked" }
            }
          ]
        }
      ]
    },
    {
      "name": "AddTrustedIP",
      "trigger": {
        "kind": "external_stimulus",
        "name": "UserAddsTrustedIP",
        "parameters": [
          { "name": "user" },
          { "name": "ip" }
        ]
      },
      "let_bindings": [],
      "requires": [
        {
          "kind": "comparison",
          "operator": "=",
          "left": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "user" },
            "field": "status"
          },
          "right": { "kind": "literal", "type": "enum_value", "value": "active" }
        },
        {
          "kind": "not",
          "operand": {
            "kind": "membership",
            "element": { "kind": "field_access", "object": null, "field": "ip" },
            "collection": {
              "kind": "field_access",
              "object": { "kind": "field_access", "object": null, "field": "user" },
              "field": "trusted_ips"
            }
          }
        }
      ],
      "ensures": [
        {
          "kind": "set_mutation",
          "target": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "user" },
            "field": "trusted_ips"
          },
          "operation": "add",
          "value": { "kind": "field_access", "object": null, "field": "ip" }
        }
      ]
    }
  ],
  "actors": [
    {
      "name": "AuthenticatedUser",
      "identified_by": {
        "entity": "User",
        "condition": {
          "kind": "comparison",
          "operator": ">",
          "left": {
            "kind": "collection_op",
            "operation": "count",
            "collection": {
              "kind": "field_access",
              "object": null,
              "field": "active_sessions"
            }
          },
          "right": { "kind": "literal", "type": "integer", "value": 0 }
        }
      }
    },
    {
      "name": "Visitor",
      "identified_by": {
        "entity": "User",
        "condition": {
          "kind": "comparison",
          "operator": "!=",
          "left": { "kind": "field_access", "object": null, "field": "status" },
          "right": { "kind": "literal", "type": "enum_value", "value": "deactivated" }
        }
      }
    }
  ],
  "surfaces": [
    {
      "name": "Authentication",
      "facing": {
        "binding": "visitor",
        "type": "Visitor"
      },
      "context": null,
      "let_bindings": [],
      "exposes": [],
      "provides": [
        {
          "kind": "action",
          "trigger": "UserLogsIn",
          "arguments": [
            { "name": "email" },
            { "name": "password" }
          ],
          "when": {
            "kind": "not",
            "operand": {
              "kind": "field_access",
              "object": { "kind": "field_access", "object": null, "field": "visitor" },
              "field": "is_locked"
            }
          }
        },
        {
          "kind": "action",
          "trigger": "UserRegisters",
          "arguments": [
            { "name": "email" },
            { "name": "password" }
          ],
          "when": null
        },
        {
          "kind": "action",
          "trigger": "UserRequestsPasswordReset",
          "arguments": [
            { "name": "email" }
          ],
          "when": null
        }
      ],
      "guarantees": [
        {
          "name": "NoSessionRequired",
          "description": "Accessible without an existing session."
        }
      ],
      "guidance": [
        "Show lockout status and unlock time when user.is_locked.",
        "Validate password length client-side before submission."
      ],
      "related": [],
      "timeout": []
    },
    {
      "name": "PasswordReset",
      "facing": {
        "binding": "visitor",
        "type": "Visitor"
      },
      "context": {
        "binding": "token",
        "type": "PasswordResetToken"
      },
      "let_bindings": [],
      "exposes": [
        {
          "expression": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "visitor" },
            "field": "email"
          }
        },
        {
          "expression": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "token" },
            "field": "is_valid"
          }
        },
        {
          "expression": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "token" },
            "field": "expires_at"
          }
        }
      ],
      "provides": [
        {
          "kind": "action",
          "trigger": "UserResetsPassword",
          "arguments": [
            { "name": "token" },
            { "name": "new_password" }
          ],
          "when": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "token" },
            "field": "is_valid"
          }
        }
      ],
      "guarantees": [
        {
          "name": "NoSessionRequired",
          "description": "Accessible without an existing session."
        }
      ],
      "guidance": [],
      "related": [],
      "timeout": []
    },
    {
      "name": "AccountManagement",
      "facing": {
        "binding": "user",
        "type": "AuthenticatedUser"
      },
      "context": null,
      "let_bindings": [],
      "exposes": [
        {
          "expression": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "user" },
            "field": "email"
          }
        },
        {
          "expression": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "user" },
            "field": "active_sessions"
          }
        },
        {
          "expression": {
            "kind": "collection_op",
            "operation": "count",
            "collection": {
              "kind": "field_access",
              "object": { "kind": "field_access", "object": null, "field": "user" },
              "field": "active_sessions"
            }
          }
        }
      ],
      "provides": [
        {
          "kind": "for_each",
          "binding": "session",
          "collection": {
            "kind": "field_access",
            "object": { "kind": "field_access", "object": null, "field": "user" },
            "field": "active_sessions"
          },
          "items": [
            {
              "kind": "action",
              "trigger": "UserLogsOut",
              "arguments": [
                { "name": "session" }
              ],
              "when": null
            }
          ]
        },
        {
          "kind": "action",
          "trigger": "UserRequestsPasswordReset",
          "arguments": [
            {
              "name": "email",
              "expression": {
                "kind": "field_access",
                "object": { "kind": "field_access", "object": null, "field": "user" },
                "field": "email"
              }
            }
          ],
          "when": null
        }
      ],
      "guarantees": [],
      "guidance": [],
      "related": [],
      "timeout": []
    }
  ],
  "deferred": [
    {
      "name": "PasswordStrengthCheck",
      "method": "evaluate",
      "location_hint": "detailed/password-strength.allium"
    }
  ],
  "open_questions": []
}
